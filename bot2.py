# --- Pháº§n 1: Nháº­p cÃ¡c thÆ° viá»‡n cáº§n thiáº¿t ---import discordfrom discord.ext import commandsimport google.generativeai as genaiimport osfrom flask import Flaskfrom threading import Thread# --- Pháº§n 2: Táº£i vÃ  cáº¥u hÃ¬nh cÃ¡c khÃ³a bÃ­ máº­t ---from dotenv import load_dotenvload_dotenv()DISCORD_TOKEN = os.getenv('DISCORD_TOKEN')GOOGLE_API_KEY = os.getenv('GOOGLE_API_KEY')AI_INSTRUCTION = os.getenv('AI_INSTRUCTION')if not DISCORD_TOKEN or not GOOGLE_API_KEY:    print("Lá»–I: Vui lÃ²ng thiáº¿t láº­p DISCORD_TOKEN vÃ  GOOGLE_API_KEY trong tá»‡p .env")    exit()genai.configure(api_key=GOOGLE_API_KEY)# --- Pháº§n 3: Thiáº¿t láº­p mÃ´ hÃ¬nh AI ---model_choice = input("chá»n model:\n1.gemini-2.5-flash,\n2.gemini-2.5-pro,\n3.tá»± nháº­p model\n")if model_choice == "1":    model = genai.GenerativeModel('gemini-2.5-flash')elif model_choice == "2":    model = genai.GenerativeModel('gemini-2.5-pro')elif model_choice == "3":    model = input("nháº­p model:")else:    print("Lá»±a chá»n khÃ´ng há»£p lá»‡, máº·c Ä‘á»‹nh sá»­ dá»¥ng gemini-1.5-flash.")    model = genai.GenerativeModel('gemini-1.5-flash')# --- Pháº§n 4: Bá»™ nhá»› há»™i thoáº¡i cho tá»«ng user ---user_chats = {}  # dict: {user_id: ChatSession}# ğŸ‘‰ Thay sá»‘ nÃ y báº±ng ID Discord tháº­t cá»§a anh Äáº¡tOWNER_ID = 1067374135220649985  def hoiai(user_id: int, username: str, question: str) -> str:    """    Gá»­i cÃ¢u há»i Ä‘áº¿n Google AI vá»›i bá»™ nhá»› há»™i thoáº¡i riÃªng theo tá»«ng user.    """    global user_chats    try:        # Náº¿u user chÆ°a cÃ³ session thÃ¬ táº¡o má»›i        if user_id not in user_chats:            user_chats[user_id] = model.start_chat(history=[])        # Náº¿u lÃ  anh Äáº¡t thÃ¬ gá»i lÃ  "anh Äáº¡t"        if user_id == OWNER_ID:            display_name = "anh Äáº¡t"        else:            display_name = username  # tÃªn hiá»ƒn thá»‹ cá»§a ngÆ°á»i khÃ¡c        # GhÃ©p cÃ¢u há»i vá»›i tÃªn ngÆ°á»i dÃ¹ng        if not user_chats[user_id].history:            prompt = f"{AI_INSTRUCTION}\n\n{display_name} há»i: {question}"        else:            prompt = f"{display_name} há»i: {question}"        response = user_chats[user_id].send_message(prompt)        return response.text    except Exception as e:        print(f"ÄÃ£ xáº£y ra lá»—i khi gá»i API: {e}")        return "Xin lá»—i, em bá»‹ sá»± cá»‘ khi káº¿t ná»‘i vá»›i bá»™ nÃ£o AI ğŸ§ ğŸ’¥"# --- Pháº§n 5: Thiáº¿t láº­p Bot Discord ---intents = discord.Intents.default()intents.message_content = Trueintents.members = Truebot = commands.Bot(command_prefix='!', intents=intents)# Biáº¿n toÃ n cá»¥c Ä‘á»ƒ lÆ°u ID kÃªnh chatchat_channel_id = None@bot.eventasync def on_ready():    print(f'Bot {bot.user} Ä‘Ã£ online rá»“i ğŸ˜')    print(f'{AI_INSTRUCTION}')    print('________________________________')    try:        synced = await bot.tree.sync()        print(f"ÄÃ£ Ä‘á»“ng bá»™ {len(synced)} lá»‡nh.")    except Exception as e:        print(f"Lá»—i khi Ä‘á»“ng bá»™ lá»‡nh: {e}")# --- Lá»‡nh set/unset kÃªnh auto chat ---@bot.tree.command(name="set_chat_channel", description="Thiáº¿t láº­p kÃªnh nÃ y lÃ  kÃªnh bot tá»± Ä‘á»™ng tráº£ lá»i.")@commands.has_permissions(manage_channels=True)async def set_chat_channel(interaction: discord.Interaction):    global chat_channel_id    chat_channel_id = interaction.channel_id    await interaction.response.send_message(f"âœ… KÃªnh nÃ y (<#{chat_channel_id}>) Ä‘Ã£ Ä‘Æ°á»£c thiáº¿t láº­p lÃ  kÃªnh chat AI tá»± Ä‘á»™ng.")    print(f"KÃªnh chat AI Ä‘Æ°á»£c thiáº¿t láº­p: {interaction.channel.name} (ID: {chat_channel_id})")@bot.tree.command(name="unset_chat_channel", description="Há»§y bá» kÃªnh bot tá»± Ä‘á»™ng tráº£ lá»i.")@commands.has_permissions(manage_channels=True)async def unset_chat_channel(interaction: discord.Interaction):    global chat_channel_id    if chat_channel_id is not None:        chat_channel_id = None        await interaction.response.send_message("âŒ KÃªnh chat AI tá»± Ä‘á»™ng Ä‘Ã£ Ä‘Æ°á»£c há»§y bá».")        print("KÃªnh chat AI tá»± Ä‘á»™ng Ä‘Ã£ Ä‘Æ°á»£c há»§y bá».")    else:        await interaction.response.send_message("KhÃ´ng cÃ³ kÃªnh nÃ o Ä‘Æ°á»£c thiáº¿t láº­p lÃ m kÃªnh chat AI.")# --- Lá»‡nh há»i nhanh AI ---@bot.tree.command(name="ask", description="Há»i AI má»™t cÃ¢u nhanh")async def ask(interaction: discord.Interaction, *, question: str):    await interaction.response.defer()    answer = hoiai(interaction.user.id, interaction.user.display_name, question)    await interaction.followup.send(answer)# --- Lá»‡nh reset bá»™ nhá»› ---@bot.tree.command(name="reset", description="XÃ³a bá»™ nhá»› há»™i thoáº¡i AI (riÃªng cho báº¡n)")async def reset(interaction: discord.Interaction):    global user_chats    user_chats[interaction.user.id] = model.start_chat(history=[])    await interaction.response.send_message("ğŸ§¹ Bá»™ nhá»› há»™i thoáº¡i AI cá»§a báº¡n Ä‘Ã£ Ä‘Æ°á»£c reset!")# --- Xá»­ lÃ½ tin nháº¯n trong kÃªnh ---@bot.eventasync def on_message(message):    global chat_channel_id    if message.author == bot.user:        return    if message.content.lower().startswith('alo mikasa!'):        await message.channel.send(f'dáº¡ {message.author.mention}, em cÃ²n on áº¡ ğŸ˜š')        return    is_in_chat_channel = (message.channel.id == chat_channel_id)    is_bot_mentioned = bot.user.mentioned_in(message)    if is_in_chat_channel or is_bot_mentioned:        question = (            message.content            .replace(f'<@!{bot.user.id}>', '')            .replace(f'<@{bot.user.id}>', '')            .strip()        )        if question:            async with message.channel.typing():                print(f"Nháº­n cÃ¢u há»i tá»« '{message.author}' á»Ÿ kÃªnh {'tá»± Ä‘á»™ng' if is_in_chat_channel else 'thÆ°á»ng'}: {question}")                answer = hoiai(message.author.id, message.author.display_name, question)                print(f"Gá»­i cÃ¢u tráº£ lá»i: {answer}")                await message.reply(answer)    await bot.process_commands(message)# --- Pháº§n 6: Thiáº¿t láº­p Flask Web Server ---app = Flask('')@app.route('/')def home():    return "Bot is alive!"def run():    app.run(host='0.0.0.0', port=5000)def keep_alive():    t = Thread(target=run)    t.start()# --- Pháº§n 7: Cháº¡y Bot ---print("Äang khá»Ÿi Ä‘á»™ng web server...")keep_alive()print("Äang khá»Ÿi Ä‘á»™ng bot...")bot.run(DISCORD_TOKEN)